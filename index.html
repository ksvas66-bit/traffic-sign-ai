<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Traffic Sign AI Robot</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
body{
    text-align:center;
    font-family:Arial;
    background:#f2f2f2;
}

canvas{
    border:4px solid black;
    margin-top:10px;
}

button{
    font-size:20px;
    padding:12px;
}

#label{
    font-size:26px;
    color:green;
    font-weight:bold;
    margin-top:10px;
}
</style>
</head>

<body>

<h2>Traffic Sign Robot</h2>

<button onclick="init()">START CAMERA</button>

<div id="webcam-container"></div>
<div id="label">Prediction: NONE</div>

<script>

const URL = "https://teachablemachine.withgoogle.com/models/DXF2w_wXO/";

let model, webcam, maxPredictions;
let lastCommand = "";

async function init() {

    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    model = await tmImage.load(modelURL, metadataURL);

    // ‚≠ê VERY IMPORTANT LINE
    maxPredictions = model.getTotalClasses();

    webcam = new tmImage.Webcam(224,224,true); // true = remove mirror
    await webcam.setup({
   facingMode: "environment"
});

    await webcam.play();

    document.getElementById("webcam-container")
        .appendChild(webcam.canvas);

    window.requestAnimationFrame(loop);
}

async function loop(){
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
}

async function predict(){

    const prediction = await model.predict(webcam.canvas);

    let highest = prediction[0];

    for(let i=1;i<prediction.length;i++){
        if(prediction[i].probability > highest.probability){
            highest = prediction[i];
        }
    }

    if(highest.probability > 0.85){

        const label = highest.className.trim();

        document.getElementById("label")
        .innerText = "Prediction: " + label;

        sendCommand(label);
    }
}

function sendCommand(label){

    let cmd = "";

    const L = label.toUpperCase();

    if(L.includes("STOP"))
        cmd="S";

    else if(L.includes("LEFT"))
        cmd="L";

    else if(L.includes("RIGHT"))
        cmd="R";

    else if(L.includes("UTURN"))
        cmd="U";

    else if(L.includes("ROUND"))
        cmd="A";

    else
        cmd="F";

    // prevent spam
    if(cmd !== lastCommand){

        lastCommand = cmd;

        if(window.AppInventor){
            window.AppInventor.setWebViewString(cmd);
        }
    }
}

</script>

</body>
</html>


