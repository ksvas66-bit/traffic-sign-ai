<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Traffic Sign Recognition</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
body{
  text-align:center;
  font-family:Arial;
  background:#f2f2f2;
}

canvas{
  border:3px solid black;
  margin-top:10px;
}

button{
  font-size:20px;
  padding:12px;
  margin-top:10px;
}

#label{
  font-size:26px;
  font-weight:bold;
  color:green;
  margin-top:15px;
}
</style>
</head>

<body>

<h2>Traffic Sign Recognition Robot</h2>

<button onclick="init()">START CAMERA</button>

<div id="webcam-container"></div>
<div id="label">Waiting for sign...</div>

<script>

const URL = "https://teachablemachine.withgoogle.com/models/DXF2w_wXO/";

let model, webcam, maxPredictions;

const CONFIDENCE = 0.80;   // ignore weak predictions
const REQUIRED = 6;        // stability frames

let lastLabel = "";
let stableCount = 0;
let lastSent = "";        // prevents command spam

//----------------------------------------

async function init() {

const modelURL = URL + "model.json";
const metadataURL = URL + "metadata.json";

model = await tmImage.load(modelURL, metadataURL);
maxPredictions = model.getTotalClasses();

webcam = new tmImage.Webcam(224,224,false);
await webcam.setup({ facingMode:"environment" });
await webcam.play();

document.getElementById("webcam-container").innerHTML="";
document.getElementById("webcam-container").appendChild(webcam.canvas);

window.requestAnimationFrame(loop);
}

//----------------------------------------

async function loop(){
webcam.update();
await predict();
window.requestAnimationFrame(loop);
}

//----------------------------------------

async function predict(){

const prediction = await model.predict(webcam.canvas);

// find highest prediction
let top = prediction[0];

for(let i=1;i<prediction.length;i++){
    if(prediction[i].probability > top.probability){
        top = prediction[i];
    }
}

// ignore weak confidence
if(top.probability < CONFIDENCE){
    stableCount = 0;
    return;
}

let current = top.className.toLowerCase();

// stability check
if(current === lastLabel){
    stableCount++;
}else{
    lastLabel = current;
    stableCount = 1;
}

if(stableCount < REQUIRED) return;

// SHOW LABEL
document.getElementById("label").innerHTML =
current.toUpperCase() + " (" + Math.round(top.probability*100) + "%)";

//----------------------------------------
// COMMAND SECTION (VERY IMPORTANT)
//----------------------------------------

let cmd = "";

if(current === "stop")
    cmd = "S";

else if(current === "left")
    cmd = "L";

else if(current === "right")
    cmd = "R";

else if(current === "forward")
    cmd = "F";

else if(current === "uturn")
    cmd = "U";

else if(current === "roundabout")
    cmd = "A";

else if(current === "none")
    cmd = "";   // do nothing

//----------------------------------------
// SEND TO MIT APP INVENTOR
//----------------------------------------

if(cmd !== "" && cmd !== lastSent){

    lastSent = cmd;

    if(window.AppInventor){
        window.AppInventor.setWebViewString(cmd);
    }

    console.log("Command Sent:", cmd);
}

}

</script>

</body>
</html>

