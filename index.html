<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

<style>
body{
    text-align:center;
    font-family:Arial;
    background:#f2f2f2;
}

video{
    width:320px;
    height:240px;
    border:4px solid black;
    border-radius:10px;
    object-fit:cover;
}

button{
    padding:15px;
    font-size:18px;
    margin-top:15px;
}

#label{
    font-size:28px;
    font-weight:bold;
    color:green;
    margin-top:10px;
}
</style>
</head>

<body>

<h2>Traffic Sign AI</h2>

<button onclick="startCamera()">START CAMERA</button>

<br><br>

<video id="video" autoplay playsinline></video>

<div id="label">Prediction: NONE</div>

<script>

let model, webcam, maxPredictions;
const URL = "PASTE_YOUR_TEACHABLE_MACHINE_MODEL_LINK_HERE/"; 
// example:
// https://teachablemachine.withgoogle.com/models/XXXX/

async function startCamera(){

try{

    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    const stream = await navigator.mediaDevices.getUserMedia({
        video:{
            facingMode:{ exact:"environment" } // ⭐ rear camera
        },
        audio:false
    });

    const video = document.getElementById("video");
    video.srcObject = stream;

    video.onloadedmetadata = () => {
        predictLoop(video);
    };

}catch(err){

    // fallback if exact rear cam not supported
    const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:"environment" },
        audio:false
    });

    const video = document.getElementById("video");
    video.srcObject = stream;

    video.onloadedmetadata = () => {
        predictLoop(video);
    };
}
}


async function predictLoop(video){

while(true){

    const prediction = await model.predict(video);

    let highestProb = 0;
    let bestClass = "NONE";

    for(let i=0;i<prediction.length;i++){

        if(prediction[i].probability > highestProb){

            highestProb = prediction[i].probability;
            bestClass = prediction[i].className;
        }
    }

    bestClass = bestClass.toUpperCase();

    document.getElementById("label").innerHTML =
        "Prediction: " + bestClass + " (" +
        (highestProb*100).toFixed(0) + "%)";


    // ⭐⭐⭐ CONFIDENCE FILTER (VERY IMPORTANT)
    if(highestProb > 0.85){

        sendCommand(bestClass);
    }

    await new Promise(r=>setTimeout(r,120)); // bluetooth safe speed
}
}



function sendCommand(label){

let cmd = "";

// ⭐ MATCH YOUR TM CLASS NAMES EXACTLY
if(label.includes("STOP"))
    cmd="S";

else if(label.includes("LEFT"))
    cmd="L";

else if(label.includes("RIGHT"))
    cmd="R";

else if(label.includes("UTURN"))
    cmd="U";

else if(label.includes("ROUND"))
    cmd="A";

else if(label.includes("FORWARD"))
    cmd="F";

else if(label.includes("REVERSE"))
    cmd="B";

else
    cmd="N"; // NONE



console.log("Sending:",cmd);


// ⭐⭐⭐ SEND CONTINUOUSLY (NO lastCommand!)
if(window.AppInventor){

    window.AppInventor.setWebViewString(cmd);
}

}

</script>

</body>
</html>
