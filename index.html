<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Traffic Sign AI</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
body{
    text-align:center;
    font-family:Arial;
    background:#eeeeee;
}

button{
    padding:12px;
    font-size:20px;
    margin-top:10px;
}

canvas{
    border:4px solid black;
    margin-top:10px;
}

#label{
    font-size:26px;
    font-weight:bold;
    color:green;
    margin-top:10px;
}
</style>
</head>

<body>

<h2>Traffic Sign Recognition</h2>

<button onclick="init()">START CAMERA</button>

<div id="webcam-container"></div>
<div id="label">Prediction: NONE</div>

<script>

const URL = "https://teachablemachine.withgoogle.com/models/DXF2w_wXO/";

let model, webcam;
let lastCommand = "";

const CONFIDENCE = 0.85;   // ⭐ Strong detection only
const DELAY = 1500;       // ⭐ Prevent command spam

//--------------------------------------------------

async function init() {

    try{

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);

        // ⭐ REAR CAMERA + NO MIRROR
        webcam = new tmImage.Webcam(224,224,false);

        await webcam.setup({
            facingMode:"environment"
        });

        await webcam.play();

        document.getElementById("webcam-container")
                .appendChild(webcam.canvas);

        window.requestAnimationFrame(loop);

    }catch(err){

        alert("Camera Error → Restart App\n" + err);
        console.log(err);
    }
}

//--------------------------------------------------

async function loop(){

    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
}

//--------------------------------------------------

async function predict(){

    const predictions = await model.predict(webcam.canvas);

    predictions.sort((a,b)=>b.probability-a.probability);

    const top = predictions[0];

    if(top.probability < CONFIDENCE) return;

    let label = top.className.toUpperCase();

    document.getElementById("label").innerText =
        "Prediction: " + label +
        " (" + Math.round(top.probability*100) + "%)";

    //--------------------------------------------------
    // COMMAND MAP
    //--------------------------------------------------

    let cmd = "";

    if(label.includes("STOP"))
        cmd="S";

    else if(label.includes("LEFT"))
        cmd="L";

    else if(label.includes("RIGHT"))
        cmd="R";

    else if(label.includes("UTURN"))
        cmd="U";

    else if(label.includes("ROUND"))
        cmd="A";

    else if(label.includes("NONE"))
        return;

    //--------------------------------------------------

    if(cmd !== lastCommand){

        lastCommand = cmd;

        console.log("Sending:",cmd);

        // ⭐ SEND TO MIT APP INVENTOR
        if(window.AppInventor){

            window.AppInventor.setWebViewString(cmd);
        }

        // ⭐ small delay to avoid flooding bluetooth
        await new Promise(r=>setTimeout(r,DELAY));
    }
}

</script>

</body>
</html>

