<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Traffic Sign Robot Control</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

<style>
body{
    text-align:center;
    font-family:Arial;
}
video{
    border:3px solid black;
    border-radius:10px;
}
#label{
    font-size:30px;
    font-weight:bold;
    color:blue;
}
</style>
</head>

<body>

<h2>Traffic Sign Recognition</h2>

<button onclick="init()">START CAMERA</button>

<br><br>

<div id="webcam-container"></div>
<div id="label">Prediction: NONE</div>

<script>

const URL = "PASTE_YOUR_MODEL_LINK_HERE/"; 
// Example:
// https://teachablemachine.withgoogle.com/models/xxxxxxx/

let model, webcam, maxPredictions;
let lastCommand = "";

async function init() {

    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    webcam = new tmImage.Webcam(300, 300, false); 
    // FALSE = no mirror

    await webcam.setup({ facingMode: "environment" }); 
    await webcam.play();

    window.requestAnimationFrame(loop);

    document.getElementById("webcam-container").appendChild(webcam.canvas);
}

async function loop() {
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
}

async function predict() {

    const prediction = await model.predict(webcam.canvas);

    let highestProb = 0;
    let detectedClass = "NONE";

    for (let i = 0; i < maxPredictions; i++) {

        if (prediction[i].probability > highestProb) {
            highestProb = prediction[i].probability;
            detectedClass = prediction[i].className;
        }
    }

    // Confidence filter (VERY IMPORTANT)
    if(highestProb < 0.85){
        detectedClass = "NONE";
    }

    document.getElementById("label").innerHTML =
        "Prediction: " + detectedClass + 
        " (" + highestProb.toFixed(2) + ")";


    // Send command only if changed
    if(detectedClass !== lastCommand){

        lastCommand = detectedClass;

        // ***** THIS CALLS YOUR KODULAR APP *****
        // Kodular WebViewer receives this via "OnConsoleMessage"

        console.log(detectedClass);
    }
}

</script>

</body>
</html>
